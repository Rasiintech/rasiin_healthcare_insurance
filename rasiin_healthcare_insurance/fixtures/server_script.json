[
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Submit",
  "event_frequency": "All",
  "modified": "2025-03-19 12:55:22.482897",
  "module": "Rasiin Healthcare Insurance",
  "name": "Insurance Refund",
  "reference_doctype": "Sales Invoice",
  "script": "#Refurn Reverse bill to ...\nhis_settings = frappe.get_doc(\"HIS Settings\", \"HIS Settings\")\ninsurance_account = \"\"\ndebtor_account = \"\"\nif his_settings.insurance_receivable_account:\n    insurance_account = his_settings.insurance_receivable_account\nif his_settings.debtors_account:\n    debtor_account = his_settings.debtors_account\n# paid_amount = doc.paid_amount if doc.paid_amount else 0\n# difference = abs(paid_amount - doc.grand_total)\nif doc.insurance_company and doc.is_return:\n    insurance_refund_amount = abs( doc.insurance_coverage_amount)\n    abbr= frappe.db.get_value(\"Company\", doc.company, \"abbr\")\n    from_patient=frappe.db.get_value('Patient', doc.patient, 'customer')\n    from_patient_name=frappe.db.get_value('Patient', doc.patient, 'patient_name')\n    to_insurance=frappe.db.get_value('Insurance Company', doc.insurance_company, 'customer' )\n    to_insurance_name=doc.insurance_company\n    account = [\n\t\t\t\n\t\t{\n\t\t\t\"account\": frappe.db.get_value(\"Party Account\", {\"parent\": to_insurance}, \"account\") or insurance_account,\n\t\t\t\"party_type\": \"Customer\",\n\t\t\t\"party\" : to_insurance,\n\t\t\t\"credit_in_account_currency\": insurance_refund_amount,\n\t\t\t\"cost_center\": doc.cost_center\n\t\t\n\t\t},\n\t\t{\n\t\t\t\"account\": frappe.db.get_value(\"Party Account\", {\"parent\": from_patient}, \"account\") or debtor_account,\n\t\t\t'party_type': \"Customer\",\n\t\t\t\"party\" : from_patient,\n\t\t\t\"debit_in_account_currency\": insurance_refund_amount,\n\t\t\t\"cost_center\": doc.cost_center\n\t\t},\n    ]\n    # frappe.errprint(account)\n    Journal = frappe.get_doc({\n    \t\t'doctype': 'Journal Entry',\n    \t\t'voucher_type': 'Journal Entry',\n    \t\t\"posting_date\" : frappe.utils.getdate(),\n    \t\t\"user_remark\": f\"Refund from Patient  {from_patient_name} to Insurance {to_insurance_name} Invoice Number {doc.name}\",\n    \t\t\"accounts\": account,\n    \t\t\"patient\": doc.patient,\n    \t\t\"patient_name\": doc.patient_name,\n    \t\t\"sales_invoice\" : doc.name,\n    \t\t\"reference_invoice\": doc.name\n    \t\t\n    \t})\n    Journal.insert(ignore_permissions = True)\n    Journal.submit()\n",
  "script_type": "DocType Event"
 }
]